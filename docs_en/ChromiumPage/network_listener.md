🚤 Listening to Network Data
---

Many web page data comes from interfaces, dynamically loaded during website usage, such as pagination lists that load content using JavaScript.

These data are usually sent in JSON format, received by the browser, parsed, and then loaded into the corresponding positions in the DOM.

When doing data collection, we often retrieve the parsed data from the DOM, which may have issues such as incomplete data, delayed loading response, and difficulty in determining when loading is complete.

Wouldn't it be great if we could intercept the data packets sent and received by the browser, determine the next steps based on the packet status, and even directly obtain the data?

The DrissionPage provides a built-in listener for each page object (including tab and frame objects) specifically designed for capturing browser data packets.

It can provide the ability to wait for and capture specific data packets, and return them in real-time.

## ✅️ Examples

Let's first look at two examples to understand how the listener works.

:::warning Note
    Before performing any actions, the listener needs to be started. Data packets before calling `listen.start()` cannot be captured.
:::

### 📌 Waiting and Capturing

Click on the next page, wait for the data packet, and then click on the next page in a loop.

```python
from DrissionPage import ChromiumPage

page = ChromiumPage()
page.get('https://gitee.com/explore/all')  # Access the website, the data packet generated by this line is not captured

page.listen.start('gitee.com/explore')  # Start the listener, specifying to capture data packets containing this text
for _ in range(5):
    page('@rel=next').click()  # Click on the next page
    res = page.listen.wait()  # Wait for and capture a data packet
    print(res.url)  # Print the data packet URL
```

**Output:**

```shell
https://gitee.com/explore/all?page=2
https://gitee.com/explore/all?page=3
https://gitee.com/explore/all?page=4
https://gitee.com/explore/all?page=5
https://gitee.com/explore/all?page=6
```

---

### 📌 Real-time Capturing

Do the same thing as the previous example, but in a different way.

```python
from DrissionPage import ChromiumPage

page = ChromiumPage()
page.listen.start('gitee.com/explore')  # Start the listener, specifying to capture data packets containing this text
page.get('https://gitee.com/explore/all')  # Access the website

i = 0
for packet in page.listen.steps():
    print(packet.url)  # Print the data packet URL
    page('@rel=next').click()  # Click on the next page
    i += 1
    if i == 5:
        break
```

---

## ✅️ Setting Targets and Starting the Listener

### 📌 `listen.start()`

This method is used to start the listener and set the targets to capture.

Multiple targets can be set, and data packets that meet the conditions will be captured.

If this method is called while the listener is still running, the previously captured queue will be cleared.

|   Parameter   |             Type              | Default | Description                                                |
|:-------------:|:----------------------------:|:-------:|------------------------------------------------------------|
|   `targets`   | `str`<br/>`list`<br/>`tuple` |  `None` | URL feature to match data packets, can specify multiple using a list, `True` to capture all |
|  `is_regex`   |            `bool`            |  `None` | Whether the targets are regular expressions, `None` to keep the original setting |
|   `method`    | `str`<br/>`list`<br/>`tuple` |  `None` | Request types to listen for, can specify multiple, default is `('GET', 'POST')`, `True` to listen for all, `None` to keep the original setting |
| `res_type`    | `str`<br/>`list`<br/>`tuple` |  `None` | Resource type to listen for, can specify multiple, `True` to listen for all, `None` to keep the original setting |

**Returns:** `None`

---

### 📌 `listen.set_targets()`

This method can modify the targets to capture during the listening process, or set them before starting the listener.

The listener will not start if it has not been started yet.

|   Parameter   |             Type              |   Default   | Description                                                |
|:-------------:|:----------------------------:|:----------:|------------------------------------------------------------|
|   `targets`   | `str`<br/>`list`<br/>`tuple` |    `True`   | URL feature to match data packets, can specify multiple using a list, `True` to capture all |
|  `is_regex`   |            `bool`            |   `False`  | Whether the targets are regular expressions                |
|   `method`    | `str`<br/>`list`<br/>`tuple` | (`'GET', 'POST')` | Request types to listen for, can specify multiple, default is `('GET', 'POST')`, `True` to listen for all |
| `res_type`    | `str`<br/>`list`<br/>`tuple` |    `True`   | Resource type to listen for, can specify multiple, `True` to listen for all |

**Returns:** `None`

---

## ✅️ Waiting and Capturing Data Packets

### 📌 `listen.wait()`

This method is used to wait for a specified number of data packets that meet the requirements to arrive.

All eligible packets will be stored in a queue, and `wait()` actually retrieves results one by one from the queue, so there is no need to worry about packets being lost due to the page being refreshed.

|    Parameter Name    |       Type        | Default | Description                                                                        |
|:----------------:|:-----------------:|:-------:|------------------------------------------------------------------------------------|
|      `count`      |       `int`       |   `1`   | Number of packets to capture                                                       |
|     `timeout`     | `float`<br/>`None` |  `None`  | Timeout duration, set to `None` for unlimited wait                                 |
|   `fit_count`    |       `bool`       | `True`  | Whether the total count requirement needs to be met. If timeout, returns `False` if `True`, returns the captured packets if `False`. |
|   `raise_err`    |       `bool`       |  `None`  | Whether to throw an error when timeout occurs. If `None`, it will be based on the `Settings` setting. If not throwing, returns `False` on timeout. |

|      Return Type       | Description                                                                        |
|:---------------------:|------------------------------------------------------------------------------------|
|     `DataPacket`      | Returns a data packet object if `count` is `1` and there is no timeout              |
| `List[DataPacket]` | Returns a list of data packet objects if `count` is greater than `1` and there is no timeout or `fit_count` is `False` |
|        `False`        | Returns `False` if there is a timeout and `fit_count` is `True`                      |

---

### 📌 `listen.steps()`

This method returns an iterable object for a `for` loop, where each iteration can get a data packet.

It allows for real-time retrieval and return of data packets.

If `timeout` occurs, the loop will be interrupted.

|   Parameter Name    |        Type         | Default | Description                                                                        |
|:----------------:|:------------------:|:-------:|------------------------------------------------------------------------------------|
|     `count`      |       `int`        |  `None` | Number of packets to capture. Set to `None` for an unlimited amount.                   |
|    `timeout`    | `float`<br/>`None` |  `None` | Waiting time for each data packet. Set to `None` for unlimited wait.                  |
|       `gap`      |       `int`        |   `1`   | How many packets to receive before returning data.                                    |

|      Return Type       | Description                                          |
|:---------------------:|------------------------------------------------------|
|     `DataPacket`      | Returns a data packet object when `gap` is `1`         |
| `List[DataPacket]` | Returns a list of data packet objects when `gap` is greater than `1` |

---

### 📌 `listen.wait_silent()`

This method is used to wait for all specified requests to complete.

|   Parameter Name    |        Type         |    Default    | Description                                                                        |
|:----------------:|:------------------:|:------------:|------------------------------------------------------------------------------------|
|    `timeout`     | `float`<br/>`None` |    `None`    | Waiting time. Set to `None` for unlimited wait.                                     |
|   `targets_only` |       `bool`       |    `False`   | Whether to wait only for the requests specified in `targets`.                       |

|       Return Type      | Description                                                          |
|:----------------------:|----------------------------------------------------------------------|
|         `bool`         | Returns whether the waiting was successful.                          |

---

## ✅️ Pausing and Resuming

### 📌 `listen.pause()`

This method is used to pause the listener.

| Parameter Name |   Type   | Default | Description                                   |
| :-----------: | :------: | :-----: | --------------------------------------------- |
|    `clear`    | `bool` | `True`  | Whether to clear the already acquired queue. |

**Returns:** `None`

---

### 📌 `listen.resume()`

This method is used to continue the paused listener.

**Parameters:** None

**Returns:** `None`

---

### 📌 `listen.stop()`

This method is used to terminate the listener, and it will clear the acquired queue while keeping the targets.

**Parameters:** None

**Returns:** `None`

---

## ✅️ `DataPacket` Object

The `DataPacket` object is the result object of the acquired data packet, which contains various information about the data packet.

### 📌 `Object Properties`

|   Property Name   |  Data Type  | Description                    |
|:--------------:|:----------:|----------------------------|
|    `tab_id`    |   `str`    | ID of the tab that made the request |
|   `frameId`    |   `str`    | ID of the frame that made the request |
|    `target`    |   `str`    | Listening target that made the request |
|     `url`      |   `str`    | URL of the data packet request |
|    `method`    |   `str`    | Type of request |
|  `is_failed`   |   `bool`   | Whether the connection failed |
| `resourceType` |   `str`    | Type of resource |
|   `request`    | `Request`  | Object that holds request information |
|   `response`   | `Response` | Object that holds response information |
|  `fail_info`   | `FailInfo` | Object that holds connection failure information |

### 📌 `wait_extra_info()`

Some data packets have `extra_info` data, but this data may be loaded later than the data packet. Use this method to wait for the data to be loaded into the data packet object.

|   Parameter Name    |        Type         | Default | Description                    |
|:---------------:|:-----------------:|:-------:|----------------------------|
|     `timeout`    | `float`<br/>`None` |  `None` | Timeout duration, set to `None` for unlimited wait. |

| Return Type | Description |
| ----------- | ----------- |
| `bool` | Whether it waits successfully |

### 📌 `Request` Object

The `Request` object is an object used to store request information within the `DataPacket` object. It has the following properties:

| Property Name | Data Type | Description |
| ------------- | --------- | ----------- |
| `headers` | `CaseInsensitiveDict` | Returns headers data as a case-insensitive dictionary |
| `postData` | `str`<br/>`dict` | Data submitted for requests of type post |

In addition to the above properties, the `Request` object can access other fields using a key or specifying a property, including:

url, method, urlFragment, hasPostData, postDataEntries, mixedContentType, initialPriority, referrerPolicy, isLinkPreload, trustTokenParams, isSameSite

---

### 📌 `Response` Object

The `Response` object is an object used to store response information within the `DataPacket` object. It has the following properties:

| Property Name | Data Type | Description |
| ------------- | --------- | ----------- |
| `headers` | `CaseInsensitiveDict` | Returns headers data as a case-insensitive dictionary |
| `body` | `str`<br/>`bytes`<br/>`dict` | Automatically converted if it is in json format, converted to base64 if it is an image format, directly returned as text for other formats |
| `raw_body` | `str` | Unprocessed body text |

In addition to the above properties, the `Response` object can access other fields using a key or specifying a property, including:

url, status, statusText, headers, headersText, mimeType, requestHeaders, requestHeadersText, connectionReused, connectionId, remoteIPAddress, remotePort, fromDiskCache, fromServiceWorker, fromPrefetchCache, encodedDataLength, timing, serviceWorkerResponseSource, responseTime, cacheStorageCacheName, protocol, alternateProtocolUsage, securityState, securityDetails

---

### 📌 `FailInfo` Object

The `FailInfo` object is an object used to store connection failure information within the `DataPacket` object. It has the following properties:

| Property Name | Data Type | Description |
| ------------- | --------- | ----------- |
| `errorText` | `str` | Error message text |
| `canceled` | `bool` | Whether it is canceled |
| `blockedReason` | `str` | Reasons for being blocked |
| `corsErrorStatus` | `str` | CORS error status |

